{% extends 'base/base.md' %}

{% block model_goals %}
Ротация изображений является частью пайплайна распознавания документа и располагается перед этапом сегментации полей.

Задача модели заключается в точной и быстрой классификации и дальнейшей ротации фотографий/сканов документов.

### Явное определение бизнес-показателей, которые будут меняться врезультате применения модели в определенном бизнес-процессе

Основные бизнес-показатели, которые будут изменяться:

1. **Точность распознавания документов**: Повышение точности сегментации полей, 
что приведет к улучшению общей точности системы распознавания документов.
2. **Скорость обработки документов**: Уменьшение времени на обработку и распознавание документов, 
что повысит общую эффективность бизнес-процесса.
3. **Снижение затрат на ручную проверку**: Снижение необходимости в ручной проверке 
и исправлении ошибок, что приведет к сокращению затрат на рабочую силу.
4. **Улучшение пользовательского опыта**: Повышение удовлетворенности клиентов за счет 
более быстрого и точного предоставления услуг, связанных с документами.

### Описание ожидаемого механизма влияния модели на бизнес-показатели

1. **Точность распознавания документов**: Модель обеспечивает высокий уровень 
ротацию документов, что непосредственно влияет на общий показатель точности распознавания 
документов. Это уменьшит количество ошибок и необходимости повторного сканирования документов.
2. **Скорость обработки документов**: Оптимизация модели позволяет значительно 
ускорить процесс инференса. Быстрая обработка документов позволит обслуживать 
больше клиентов в единицу времени, что увеличит производительность системы.
3. **Снижение затрат на ручную проверку**: Точная автоматическая сегментация 
полей документа уменьшит количество ошибок, требующих ручного вмешательства. 
Это приведет к снижению затрат на проверку и исправление данных.
4. **Улучшение пользовательского опыта**: Более точная и быстрая обработка 
документов уменьшит время ожидания для клиентов и повысит их удовлетворенность услугами, 
что в свою очередь положительно скажется на репутации компании.
{% endblock model_goals %}

{% block business_process %}
### Описание процесса AS IS и процесса TO BE

#### Процесс AS IS (текущий процесс):
1. **Получение документа**: Клиенты или сотрудники загружают фотографии или сканы в сервис распознавания изображение без гарантии правильной ориентации документа.
2. **Ручная проверка и обработка**: Сотрудники вручную проверяют ориентацию документов.
3. **Распознавание данных**: Считавают символы с этих полей.
4. **Корректировка данных**: Ручная корректировка и верификация данных.
5. **Внесение данных в систему**: Введение данных в систему после проверки.

#### Процесс TO BE (будущий процесс):
1. **Получение документа**: Клиенты или сотрудники загружают фотографии или сканы.
2. **Автоматическая ротация**: Модель автоматической поворочивает документ.

### Область применения модели

Модель применяется для автоматизации и улучшения процесса распознавания.
Является частью пайплайна распознавания, ускоряет процесс одобрения ипотеки.


### Условия применимости модели

1. **Совместимость с системой**: Модель должна быть интегрирована в существующие системы 
документооборота компании.
2. **Регулярное обновление данных**: Регулярное обновление данных и переобучение модели 
для поддержания высокой точности сегментации.
3. **Соответствие законодательным требованиям**: Продукт должен соответствовать требованиям 
по обработке и хранению персональных данных.

### Описание связи модели с другими моделями

1. **Модель ротации изображений**: Перед ротацией, изображения могут проходить 
через ряд моделей, которая улучшает качество изображения, удаляет шум, классифицируют документ.

2. **Модель сегментации**: Сегментация выделенных областей в документе.
   
3. **Модель OCR (оптического распознавания символов)**: После сегментации полей модель OCR 
извлекает текстовые данные из выделенных областей.

4. **Модель верификации данных**: После извлечения данных модель верификации проверяет 
их корректность и соответствие шаблонам.

#### Пример последовательного использования моделей в бизнес-процессе:

1. **Ротация**: Изображение проходит через модель ротации.
2. **Сегментация**: Обработанное изображение передается модели для сегментации ключевых полей.
3. **OCR**: Сегментированные поля обрабатываются моделью OCR для извлечения текстовых данных.
4. **Верификация**: Извлеченные данные проверяются моделью верификации для выявления и 
исправления ошибок.
5. **Внесение данных**: Верифицированные данные автоматически вносятся в систему.
{% endblock business_process %}

{% block target_segment_requirements %}
Модель используется для автоматизации работы менеджеров ипотеки, принимающих пакет 
документов от клиента. 
Требования к сегменту отсутствуют.
{% endblock target_segment_requirements %}

{% block model_application_procedure %}
Детально описано в блоке бизнес-процесса.
{% endblock model_application_procedure %}

{% block significance %}
Модель является ключевым инструментом для 
автоматизации и оптимизации процессов обработки данных, 
что приводит к значительному улучшению эффективности, 
снижению затрат и повышению точности, обеспечивая при 
этом высокий уровень удовлетворенности клиентов.
{% endblock significance %}

{% block business_requirements %}
### Требования к модели со стороны бизнес-заказчика

1. **Высокая точность ротации**: Модель правильно ориентирует документ на нужный угол поворота.
2. **Быстрая обработка данных**: Время обработки одного документа должно быть минимальным, 
чтобы обеспечить быструю обработку большого объема данных.
3. **Надежность и стабильность**: Модель должна быть устойчивой к различным качествам 
изображений, включая фотографии низкого качества.


### Оценка объема потока

- **Ежегодный объем**: Ожидается, что модель будет обрабатывать до 1 миллиона документов в год.
- **Ежемесячный объем**: Приблизительно 80,000 в месяц.
- **Ежедневный объем**: Примерно 2,600 в день.

### Ограничения на метрики модели со стороны бизнес-заказчика
- **Время обработки**: Каждое изображение должно обрабатываться за время, не превышающее 3 секунды.

### Ключевая метрика и обоснование ее выбора

- **Ключевая метрика**: Accuracy
  - **Обоснование выбора**: Определение ориентации изображения реализовано с помощью решения задачи классификации.
Сеть способна определять угол поворота изображения с точностью до 90 градусов.
Это сделано исходя из наблюдения, что клиенты при фотографировании или сканировании документа стараются располагать его параллельно границам области изображения. Поэтому поворот на угол, кратный 90 градусам, достаточен для выполнения следующих этапов пайплайна распознавания.

  Accuracy - это метрика, которая характеризует качество модели, агрегированное по всем классам. Это полезно, когда классы для нас имеют одинаковое значение.

Текущие поддерживаемые классы:
- 0 – документ расположен корректно, поворот изображения не требуется;
- 90 – документ на изображении повернут на 270 градусов, требуется выполнить поворот на 90 градусов;
- 180 – документ на изображении повернут на 180 градусов, требуется выполнить поворот на 180 градусов;
- 270 – документ на изображении повернут на 90 градусов, требуется выполнить поворот на 270 градусов.
{% endblock business_requirements %}

{% block data_preprocessing %}
#### Данные
Для тренировки модели использовались фотографии и сканы документа, ранее приложенные к заявкам клиентами. Все документы были проверены вручную, фотографии совсем низкого качества удалены из датасета. Кроме этого, все изображения повернуты под правильным углом.

Был использован датасет {{ mleco['dataset_name']|default('my_variable is not defined') }} (версия {{ mleco['version']|default('my_variable is not defined') }}), который загружен в хранилище датасетов mleco {{ mleco['url_dataset']|default('my_variable is not defined') }}

#### Препроцессинг
Перед подачей в сеть все изображения были сжаты до размеров (512, 512) без сохранения пропорций. Затем изображения были нормализованы, так чтобы все значения находились в диапазоне [-0.5; 0.5].


#### Датасет
- Обучающая выборка	1348 изображений
- Валидационная выборка	247
- Тестовая выборка	257
- Итоговая тестовая 257

Несмотря на небольшой размер датасета, этого достаточно для обучения сети. Помимо этого, небольшое количество документов для обучения мы компенсируем использованием предобученных весов на датасете «ImageNet». Следовательно, даже на таком количестве документов возможно достичь отличного качества.

Обучающая, валидационная и тестовые выборки были составлены следующим образом: каждое изображение было повернуто на 0, 90,180 и 270 градусов и ему сопоставлен соответствующий класс 0, 1, 2 или 3. Таким образом, датасет был увеличен в 4 раза. Так как на практике изображений, требующих поворота, крайне мало и баланс классов сильно сдвинут в сторону класса «0», в качестве тестовой выборки мы использовали изображения без поворота. Валидационная выборка использовалась для выбора лучшей эпохи.
{% endblock data_preprocessing %}

{% block model_building %}
#### Метрики и функция ошибки
Для сравнения моделей мы использовали долю правильных ответов (accuracy). В качестве функции ошибки выбрали кросс-энтропийный лосс.

### Используемый алгоритм
Модель для определения ориентации построена на основе сверточных нейронных сетей. При выборе модели мы отдавали предпочтение самым быстрым архитектурам, так как понимали, что достигнуть высокой точности на стандартных моделях будет несложно.
Поэтому, в качестве базовой архитектуры рассматривались ResNet-18 (https://arxiv.org/pdf/1512.03385.pdf) и MobileNetV2 (https://arxiv.org/abs/1801.04381). Обе модели показали 100% точность на тестовой выборке, поэтому за основу была взята более легковесная архитектура MobileNetV2.
Обучение 

1. Как было сказано ранее были проведены эксперименты с архитектурами ResNet-18 и MobileNetV2, после которых следовал один полносвязный слой.
2. Был использован transfer learning подход. В качестве инициализации весов загружались веса, полученные тренировкой классификатора на датасете «ImageNet» без последнего fully-connected слоя. Далее вся сеть обучалась на нашем датасете
3. В модели предусмотрен стандартный выход из полносвязного слоя после применения argmax для классификации.

### Гиперпараметры итоговой модели

Финальные гиперпараметры модели были следующими:

- **Архитектура модели**: MobileNetV3(версия `timm-mobilenetv3_large_100`)
- **Функция активации**: Softmax2D (используется для преобразования выходов модели 
в вероятностные распределения по классам)
- **Функция потерь**: Binary Cross-Entropy Loss (BCELoss)

#### Настройки гиперпараметров:

- **Learning rate**: Настроено на основе экспериментов для оптимального обучения.
- **Размер батча**: Определён в зависимости от ресурсов и скорости обучения.
- **Количество эпох**: Лучшее качество показано на эпохе 200.
- **seed**: для генератора случайных чисел в numpy, влияющего на распределение углов поворота в обучающей и тестовых выборках.
- **Политики обучения**: Использование методов, предотвращающих переобучение и 
оптимизирующих процесс обучения.
{% endblock model_building %}

{% block model_results %}
#### Результаты
На тестовой выборке, а также на валидационной выборке была достигнута 100% доля правильно распознанных поворотов документов.

- Данные	 Accuracy
- Валидационная выборка	100%
- Тестовая выборка	100%

{% endblock model_results %}

